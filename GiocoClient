package tps;

import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.net.*;

public class GiocoClient extends JFrame {

    private PrintWriter out;
    private JLabel stato = new JLabel("CONNETTENDO AL SERVER...");
    private JLabel scoreLabel = new JLabel("0 - 0");
    private JLabel mossaServerLabel = new JLabel("-");
    private JLabel mossaClientLabel = new JLabel("-");
    private JLabel timerLabel = new JLabel("00");
    private JButton[] bottoni = new JButton[3];
    private boolean turnoClient = false;
    private Timer timer;

    public GiocoClient() {
        super("Sasso-Carta-Forbice - CLIENT (Stadio)");
        getContentPane().setBackground(UIStyle.FIELD_GREEN);
        setLayout(new BorderLayout(15, 15));

        // HEADER
        JPanel scoreboard = UIStyle.createScorePanel();
        scoreboard.setLayout(new GridLayout(2, 3, 20, 10));

        JLabel lblServer = new JLabel("SERVER", SwingConstants.CENTER);
        lblServer.setForeground(UIStyle.HOME_COLOR);
        lblServer.setFont(UIStyle.TITLE);

        JLabel lblClient = new JLabel("CLIENT", SwingConstants.CENTER);
        lblClient.setForeground(UIStyle.AWAY_COLOR);
        lblClient.setFont(UIStyle.TITLE);

        scoreLabel.setFont(UIStyle.SCORE_FONT);
        scoreLabel.setForeground(UIStyle.TEXT);
        scoreLabel.setHorizontalAlignment(SwingConstants.CENTER);

        mossaServerLabel.setFont(UIStyle.NORMAL);
        mossaServerLabel.setForeground(UIStyle.TEXT);
        mossaServerLabel.setHorizontalAlignment(SwingConstants.CENTER);

        mossaClientLabel.setFont(UIStyle.NORMAL);
        mossaClientLabel.setForeground(UIStyle.TEXT);
        mossaClientLabel.setHorizontalAlignment(SwingConstants.CENTER);

        timerLabel.setFont(UIStyle.TITLE);
        timerLabel.setForeground(Color.ORANGE);
        timerLabel.setHorizontalAlignment(SwingConstants.CENTER);

        scoreboard.add(lblServer);
        scoreboard.add(scoreLabel);
        scoreboard.add(lblClient);
        scoreboard.add(mossaServerLabel);
        scoreboard.add(timerLabel);
        scoreboard.add(mossaClientLabel);

        add(scoreboard, BorderLayout.NORTH);

        // CAMPO
        JPanel field = UIStyle.createFieldPanel();
        field.setLayout(new GridLayout(1, 3, 40, 0));
        String[] mosse = {"Sasso", "Carta", "Forbice"};

        for (int i = 0; i < 3; i++) {
            JButton b = UIStyle.createButton(mosse[i]);
            b.setEnabled(false);
            final int index = i;
            b.addActionListener(e -> {
                if (turnoClient) {
                    String scelta = mosse[index].toLowerCase();
                    mossaClientLabel.setText(scelta.toUpperCase());
                    setButtonsEnabled(false);
                    turnoClient = false;
                    stopTimer();
                    out.println(scelta);
                }
            });
            bottoni[i] = b;
            field.add(b);
        }

        add(field, BorderLayout.CENTER);

        // FOOTER
        stato.setHorizontalAlignment(SwingConstants.CENTER);
        stato.setFont(UIStyle.TITLE);
        stato.setForeground(UIStyle.TEXT);

        JPanel footer = UIStyle.createFooterPanel();
        footer.setLayout(new BorderLayout());
        footer.add(stato, BorderLayout.CENTER);

        add(footer, BorderLayout.SOUTH);

        setSize(900, 550);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setVisible(true);

        new Thread(this::startClient).start();
    }

    // ⭐ EFFETTO GOAL (LAMPEGGIO)
    private void goalAnimation(JLabel label) {
        new Thread(() -> {
            try {
                for (int i = 0; i < 4; i++) {
                    label.setForeground(Color.YELLOW);
                    Thread.sleep(150);
                    label.setForeground(UIStyle.TEXT);
                    Thread.sleep(150);
                }
            } catch (Exception ignored) {}
        }).start();
    }

    private void startClient() {
        try {
            String serverIP = JOptionPane.showInputDialog(this, "Inserisci l'IP del server:", "127.0.0.1");
            if (serverIP == null || serverIP.isEmpty()) serverIP = "127.0.0.1";

            Socket socket = new Socket(serverIP, 5000);
            out = new PrintWriter(socket.getOutputStream(), true);
            BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));

            SwingUtilities.invokeLater(() -> {
                stato.setText("CONNESSO! IN ATTESA DEL FISCHIO...");
                stato.setForeground(UIStyle.AWAY_COLOR);
            });

            while (true) {
                String cmd = in.readLine();
                if (cmd == null) break;

                if (cmd.equals("INSERISCI_MOSSA")) {
                    turnoClient = true;
                    SwingUtilities.invokeLater(() -> {
                        stato.setText("TOCCA A TE! SCEGLI LA MOSSA!");
                        stato.setForeground(UIStyle.AWAY_COLOR);
                        setButtonsEnabled(true);
                        mossaServerLabel.setText("-");
                        mossaClientLabel.setText("-");
                        mossaServerLabel.setForeground(UIStyle.TEXT);
                        mossaClientLabel.setForeground(UIStyle.TEXT);
                    });
                    startTimer(10);

                } else if (cmd.startsWith("RISULTATO:TIMEOUT")) {
                    SwingUtilities.invokeLater(() -> {
                        stato.setText("TIMEOUT! SERVER SEGNA.");
                        stato.setForeground(Color.RED);
                    });

                } else if (cmd.startsWith("RISULTATO:")) {
                    String[] dati = cmd.substring(10).split(";");
                    String mossaSrv = dati[0];
                    String mossaCli = dati[1];
                    int res = Integer.parseInt(dati[2]);

                    String msg = switch (res) {
                        case 0 -> "PAREGGIO! NESSUN GOL.";
                        case 1 -> "SERVER SEGNA!";
                        case 2 -> "CLIENT SEGNA! GOL!";
                        default -> "";
                    };

                    SwingUtilities.invokeLater(() -> {
                        mossaServerLabel.setText(mossaSrv.toUpperCase());
                        mossaClientLabel.setText(mossaCli.toUpperCase());
                        stato.setText(msg);

                        // ⭐ COLORI + LAMPEGGIO
                        if (res == 1) {
                            mossaServerLabel.setForeground(Color.GREEN);
                            mossaClientLabel.setForeground(Color.RED);
                            goalAnimation(scoreLabel);
                        } else if (res == 2) {
                            mossaServerLabel.setForeground(Color.RED);
                            mossaClientLabel.setForeground(Color.GREEN);
                            goalAnimation(scoreLabel);
                        } else {
                            mossaServerLabel.setForeground(Color.YELLOW);
                            mossaClientLabel.setForeground(Color.YELLOW);
                        }
                    });

                    String punteggio = in.readLine();
                    if (punteggio != null && punteggio.startsWith("PUNTEGGIO:")) {
                        String s = punteggio.substring(10).replace(";", " - ");
                        SwingUtilities.invokeLater(() -> scoreLabel.setText(s));
                    }
                }
            }

        } catch (Exception e) {
            SwingUtilities.invokeLater(() -> {
                stato.setText("OFFLINE. IMPOSSIBILE COLLEGARSI.");
                stato.setForeground(Color.RED);
            });
            e.printStackTrace();
        }
    }

    private void startTimer(int secondi) {
        stopTimer();
        final int[] tempoRimanente = {secondi};
        timerLabel.setText(String.valueOf(tempoRimanente[0]));
        timer = new Timer(1000, e -> {
            tempoRimanente[0]--;
            timerLabel.setText(String.valueOf(tempoRimanente[0]));
            if (tempoRimanente[0] <= 0) {
                stopTimer();
                if (turnoClient) {
                    turnoClient = false;
                    setButtonsEnabled(false);
                    out.println("timeout");
                }
            }
        });
        timer.start();
    }

    private void stopTimer() {
        if (timer != null) timer.stop();
        timerLabel.setText("00");
    }

    private void setButtonsEnabled(boolean en) {
        SwingUtilities.invokeLater(() -> {
            for (JButton b : bottoni) {
                b.setEnabled(en);
                b.setBackground(en ? UIStyle.ACCENT : Color.DARK_GRAY);
            }
        });
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(GiocoClient::new);
    }
}

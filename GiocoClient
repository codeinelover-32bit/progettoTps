import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.net.*;

public class GiocoClient extends JFrame {

    private PrintWriter out;
    private JLabel stato = new JLabel("CONNETTENDO AL SERVER...");
    private JLabel TabelloneLabel = new JLabel("0 - 0");
    private JLabel mossaServerLabel = new JLabel("-");
    private JLabel mossaClientLabel = new JLabel("-");
    private JLabel timerLabel = new JLabel("00");
    private JButton[] bottoni = new JButton[3];
    private boolean turnoClient = false;
    private Timer timer;

    public GiocoClient() {
        super("Sasso-Carta-Forbice - CLIENT (Stadio)");
        getContentPane().setBackground(StiliPerGioco.CAMPO_VERDE);
        setLayout(new BorderLayout(15, 15));

        // HEADER
        JPanel tabellone = StiliPerGioco.CreazioneTab();
        tabellone.setLayout(new GridLayout(2, 3, 20, 10));

        JLabel LabelServer = new JLabel("SERVER", SwingConstants.CENTER);
        LabelServer.setForeground(StiliPerGioco.COLORE_CASA);
        LabelServer.setFont(StiliPerGioco.TITOLO);

        JLabel LabelClient = new JLabel("CLIENT", SwingConstants.CENTER);
        LabelClient.setForeground(StiliPerGioco.COLORRE_TRANSF);
        LabelClient.setFont(StiliPerGioco.TITOLO);

        TabelloneLabel.setFont(StiliPerGioco.FONT_TABELLONE);
        TabelloneLabel.setForeground(StiliPerGioco.TESTO);
        TabelloneLabel.setHorizontalAlignment(SwingConstants.CENTER);

        mossaServerLabel.setFont(StiliPerGioco.NORMALE);
        mossaServerLabel.setForeground(StiliPerGioco.TESTO);
        mossaServerLabel.setHorizontalAlignment(SwingConstants.CENTER);

        mossaClientLabel.setFont(StiliPerGioco.NORMALE);
        mossaClientLabel.setForeground(StiliPerGioco.TESTO);
        mossaClientLabel.setHorizontalAlignment(SwingConstants.CENTER);

        timerLabel.setFont(StiliPerGioco.TITOLO);
        timerLabel.setForeground(Color.ORANGE);
        timerLabel.setHorizontalAlignment(SwingConstants.CENTER);

        tabellone.add(LabelServer);
        tabellone.add(TabelloneLabel);
        tabellone.add(LabelClient);
        tabellone.add(mossaServerLabel);
        tabellone.add(timerLabel);
        tabellone.add(mossaClientLabel);

        add(tabellone, BorderLayout.NORTH);

        // CAMPO
        JPanel campo = StiliPerGioco.CreazioneCampo();
        campo.setLayout(new GridLayout(1, 3, 40, 0));
        String[] mosse = {"Sasso", "Carta", "Forbice"};

        for (int i = 0; i < 3; i++) {
            JButton b = StiliPerGioco.CreaBot(mosse[i]);
            b.setEnabled(false);
            final int index = i;
            b.addActionListener(e -> {
                if (turnoClient) {
                    String scelta = mosse[index].toLowerCase();
                    mossaClientLabel.setText(scelta.toUpperCase());
                    setButtonsEnabled(false);
                    turnoClient = false;
                    stopTimer();
                    out.println(scelta);
                }
            });
            bottoni[i] = b;
            campo.add(b);
        }

        add(campo, BorderLayout.CENTER);

        // FOOTER
        stato.setHorizontalAlignment(SwingConstants.CENTER);
        stato.setFont(StiliPerGioco.TITOLO);
        stato.setForeground(StiliPerGioco.TESTO);

        JPanel pan = StiliPerGioco.CreazioneSpeek();
        pan.setLayout(new BorderLayout());
        pan.add(stato, BorderLayout.CENTER);

        add(pan, BorderLayout.SOUTH);

        setSize(900, 550);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setVisible(true);

        new Thread(this::InizioClient).start();
    }

    // ⭐ EFFETTO GOAL (LAMPEGGIO)
    private void AnimazioneGoal(JLabel l) {
        new Thread(() -> {
            try {
                for (int i = 0; i < 4; i++) {
                    l.setForeground(Color.YELLOW);
                    Thread.sleep(150);
                    l.setForeground(StiliPerGioco.TESTO);
                    Thread.sleep(150);
                }
            } catch (Exception e) {}
        }).start();
    }

    private void InizioClient() {
        try {
            String serverIP = JOptionPane.showInputDialog(this, "Inserisci l'IP del server:", "127.0.0.1");
            if (serverIP == null || serverIP.isEmpty()) serverIP = "127.0.0.1";

            Socket socket = new Socket(serverIP, 5000);
            out = new PrintWriter(socket.getOutputStream(), true);
            BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));

            SwingUtilities.invokeLater(() -> {
                stato.setText("CONNESSO! IN ATTESA DEL FISCHIO...");
                stato.setForeground(StiliPerGioco.COLORRE_TRANSF);
            });

            while (true) {
                String comando = in.readLine();
                if (comando == null) break;

                if (comando.equals("INSERISCI_MOSSA")) {
                    turnoClient = true;
                    SwingUtilities.invokeLater(() -> {
                        stato.setText("TOCCA A TE! SCEGLI LA MOSSA!");
                        stato.setForeground(StiliPerGioco.COLORRE_TRANSF);
                        setButtonsEnabled(true);
                        mossaServerLabel.setText("-");
                        mossaClientLabel.setText("-");
                        mossaServerLabel.setForeground(StiliPerGioco.TESTO);
                        mossaClientLabel.setForeground(StiliPerGioco.TESTO);
                    });
                    InizioTimer(10);

                } else if (comando.startsWith("RISULTATO:TIMEOUT")) {
                    SwingUtilities.invokeLater(() -> {
                        stato.setText("TIMEOUT! SERVER SEGNA.");
                        stato.setForeground(Color.RED);
                    });

                } else if (comando.startsWith("RISULTATO:")) {
                    String[] dati = comando.substring(10).split(";");
                    String mossaServer = dati[0];
                    String mossaClient = dati[1];
                    int res = Integer.parseInt(dati[2]);

                    String msg;
                    switch (res) {
                        case 0:
                            msg = "PAREGGIO!";
                            break;
                        case 1:
                            msg = "SERVER SEGNA!";
                            break;
                        default:
                            msg = "CLIENT SEGNA!";
                            break;
                    }


                    SwingUtilities.invokeLater(() -> {
                        mossaServerLabel.setText(mossaServer.toUpperCase());
                        mossaClientLabel.setText(mossaClient.toUpperCase());
                        stato.setText(msg);

                        // ⭐ COLORI + LAMPEGGIO
                        if (res == 1) {
                            mossaServerLabel.setForeground(Color.GREEN);
                            mossaClientLabel.setForeground(Color.RED);
                            AnimazioneGoal(TabelloneLabel);
                        } else if (res == 2) {
                            mossaServerLabel.setForeground(Color.RED);
                            mossaClientLabel.setForeground(Color.GREEN);
                            AnimazioneGoal(TabelloneLabel);
                        } else {
                            mossaServerLabel.setForeground(Color.YELLOW);
                            mossaClientLabel.setForeground(Color.YELLOW);
                        }
                    });

                    String punteggio = in.readLine();
                    if (punteggio != null && punteggio.startsWith("PUNTEGGIO:")) {
                        String s = punteggio.substring(10).replace(";", " - ");
                        SwingUtilities.invokeLater(() -> TabelloneLabel.setText(s));
                    }
                }
            }

        } catch (Exception e) {
            SwingUtilities.invokeLater(() -> {
                stato.setText("OFFLINE. IMPOSSIBILE COLLEGARSI.");
                stato.setForeground(Color.RED);
            });
            e.printStackTrace();
        }
    }

    private void InizioTimer(int secondi) {
        stopTimer();
        final int[] tempoRimanente = {secondi};
        timerLabel.setText(String.valueOf(tempoRimanente[0]));
        timer = new Timer(1000, e -> {
            tempoRimanente[0]--;
            timerLabel.setText(String.valueOf(tempoRimanente[0]));
            if (tempoRimanente[0] <= 0) {
                stopTimer();
                if (turnoClient) {
                    turnoClient = false;
                    setButtonsEnabled(false);
                    out.println("timeout");
                }
            }
        });
        timer.start();
    }

    private void stopTimer() {
        if (timer != null) timer.stop();
        timerLabel.setText("00");
    }

    private void setButtonsEnabled(boolean en) {
        SwingUtilities.invokeLater(() -> {
            for (JButton b : bottoni) {
                b.setEnabled(en);
                b.setBackground(en ? StiliPerGioco.ORO : Color.DARK_GRAY);
            }
        });
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(GiocoClient::new);
    }
}

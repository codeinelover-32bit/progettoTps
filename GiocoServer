import java.awt.*;
import java.awt.event.ActionListener;
import java.io.*;
import java.net.*;
import java.util.concurrent.CountDownLatch;
import javax.swing.*;

public class GiocoServer extends JFrame {

    //VARIABILI
    private PrintWriter out;    // Per inviare messaggi al client
    private JLabel stato = new JLabel("IN ATTESA DEL CLIENT..."); 
    private JLabel LabelTabellone = new JLabel("0 - 0");         
    private JLabel mossaServerLabel = new JLabel("-");           
    private JLabel mossaClientLabel = new JLabel("-");           
    private JLabel timerLabel = new JLabel("00");                
    private JButton[] bottoni = new JButton[3];                  

    private int puntiServer = 0;  
    private int puntiClient = 0;  
    private String mossaServer = null;
    private Timer timer;                

    // COSTRUTTORE
    public GiocoServer() {
        super("Sasso-Carta-Forbice - SERVER (Stadio)");
        setLayout(new BorderLayout(15, 15));
        getContentPane().setBackground(StiliPerGioco.CAMPO_VERDE);

        // Crea tabellone, campo bottoni e footer
        creaTabellone();
        creaCampo();
        creaFooter();

        // Finestra principale
        setSize(900, 550);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setVisible(true);

        // Avvia thread principale del server
        new Thread(this::InizioServer).start();
    }

    // HEADER e TABELLONE
    private void creaTabellone() {
        JPanel tabellone = StiliPerGioco.CreazioneTab();
        tabellone.setLayout(new GridLayout(2, 3, 20, 10));

        JLabel LabelServer = new JLabel("SERVER", SwingConstants.CENTER);
        LabelServer.setForeground(StiliPerGioco.COLORE_CASA);
        LabelServer.setFont(StiliPerGioco.TITOLO);

        JLabel LabelClient = new JLabel("CLIENT", SwingConstants.CENTER);
        LabelClient.setForeground(StiliPerGioco.COLORRE_TRANSF);
        LabelClient.setFont(StiliPerGioco.TITOLO);

        // Tabellone centrale con punteggio
        LabelTabellone.setFont(StiliPerGioco.FONT_TABELLONE);
        LabelTabellone.setForeground(StiliPerGioco.TESTO);
        LabelTabellone.setHorizontalAlignment(SwingConstants.CENTER);

        // Stile etichette mosse
        preparaLabel(mossaServerLabel);
        preparaLabel(mossaClientLabel);

        // Timer stile
        timerLabel.setFont(StiliPerGioco.TITOLO);
        timerLabel.setForeground(Color.ORANGE);
        timerLabel.setHorizontalAlignment(SwingConstants.CENTER);

        // Aggiungi componenti al tabellone
        tabellone.add(LabelServer);
        tabellone.add(LabelTabellone);
        tabellone.add(LabelClient);
        tabellone.add(mossaServerLabel);
        tabellone.add(timerLabel);
        tabellone.add(mossaClientLabel);

        add(tabellone, BorderLayout.NORTH);
    }

    private void preparaLabel(JLabel l) {
        l.setFont(StiliPerGioco.NORMALE);
        l.setForeground(StiliPerGioco.TESTO);
        l.setHorizontalAlignment(SwingConstants.CENTER);
    }

    //CAMPO 
    private void creaCampo() {
        JPanel campo = StiliPerGioco.CreazioneCampo();
        campo.setLayout(new GridLayout(1, 3, 40, 0));

        String[] mosse = {"Sasso", "Carta", "Forbice"};

        for (int i = 0; i < 3; i++) {
            JButton b = StiliPerGioco.CreaBot(mosse[i]);
            b.setEnabled(false); // inizialmente disabilitati
            bottoni[i] = b;
            campo.add(b);
        }

        add(campo, BorderLayout.CENTER);
    }

    //MESSAGGI NELLO SPAZIO VERDE SCURO
    private void creaFooter() {
        stato.setHorizontalAlignment(SwingConstants.CENTER);
        stato.setFont(StiliPerGioco.TITOLO);
        stato.setForeground(StiliPerGioco.TESTO);

        JPanel pan = StiliPerGioco.CreazioneSpeek();
        pan.setLayout(new BorderLayout());
        pan.add(stato, BorderLayout.CENTER);

        add(pan, BorderLayout.SOUTH);
    }

    // LAMPEGGIO DEL RISULTATO
    private void AnimazioneGoal(JLabel l) {
        new Thread(() -> {
            try {
                for (int i = 0; i < 4; i++) {
                    l.setForeground(Color.YELLOW);
                    Thread.sleep(150);
                    l.setForeground(StiliPerGioco.TESTO);
                    Thread.sleep(150);
                }
            } catch (Exception ignored) {}
        }).start();
    }

    // LOGICA DEL SERVER 
    private void InizioServer() {
        try (ServerSocket serverSocket = new ServerSocket(5000)) {

            Socket clientSocket = serverSocket.accept(); // aspetta connessione client
            out = new PrintWriter(clientSocket.getOutputStream(), true);
            BufferedReader riceve = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));

            // Messaggio: client connesso
            SwingUtilities.invokeLater(() -> {
                stato.setText("CLIENT CONNESSO! CALCIO D’INIZIO…");
                stato.setForeground(StiliPerGioco.COLORE_CASA);
            });

            while (true) {

                //TURNO SERVER
                CountDownLatch delta = new CountDownLatch(1);
                preparaTurnoServer(delta); // abilita bottoni server
                delta.await();              // aspetta scelta server

                //TURNO CLIENT
                out.println("INSERISCI_MOSSA"); 
                InizioTimer(10);                // avvia timer turno client

                String mossaClient = riceve.readLine(); 
                stopTimer();
                if (mossaClient == null) break;     // client disconnesso

                int res;
                String msg;

                if (mossaClient.equals("timeout")) {
                    //server segna automaticamente
                    mossaClient = "-";
                    res = 1;
                    puntiServer++;
                    msg = "TIMEOUT! SERVER SEGNA!";
                    out.println("RISULTATO:TIMEOUT;" + mossaServer + ";" + res);
                } else {
                    // Calcola vincitore
                    res = GameLogic.winner(mossaServer, mossaClient);

                    if (res == 1) puntiServer++;
                    else if (res == 2) puntiClient++;

                    msg = switchRes(res);
                    out.println("RISULTATO:" + mossaServer + ";" + mossaClient + ";" + res);
                }

                // Aggiorna gui del server e invia punteggio
                aggiornaGraficaTurno(mossaClient, msg, res);
                out.println("PUNTEGGIO:" + puntiServer + ";" + puntiClient);

                Thread.sleep(2000); // pausa tra i turni
            }

        } catch (Exception e) {
            // Se client disconnesso
            SwingUtilities.invokeLater(() -> {
                stato.setText("CLIENT DISCONNESSO. PARTITA TERMINATA.");
                stato.setForeground(Color.RED);
            });
            e.printStackTrace();
        }
    }

    //PREPARA TURNO SERVER: abilita bottoni e resetta label
    private void preparaTurnoServer(CountDownLatch delta) {
        SwingUtilities.invokeLater(() -> {
            stato.setText("TURNO SERVER: SCEGLI LA MOSSA!");
            stato.setForeground(StiliPerGioco.COLORE_CASA);

            mossaClientLabel.setText("-");
            mossaServerLabel.setText("-");
            mossaServerLabel.setForeground(StiliPerGioco.TESTO);
            mossaClientLabel.setForeground(StiliPerGioco.TESTO);

            SetBottoni(true, delta); 
        });
    }

    // Converte risultato in messaggio 
    private String switchRes(int res) {
        switch (res) {
            case 0: return "PAREGGIO!";
            case 1: return "SERVER SEGNA!";
            default: return "CLIENT SEGNA!";
        }
    }

    // Aggiorna grafica delle mosse, punteggio e colori
    private void aggiornaGraficaTurno(String mossaClient, String msg, int res) {
        SwingUtilities.invokeLater(() -> {
            LabelTabellone.setText(puntiServer + " - " + puntiClient);
            mossaServerLabel.setText(mossaServer.toUpperCase());
            mossaClientLabel.setText(mossaClient.toUpperCase());
            stato.setText(msg);

            if (res == 1) {
                mossaServerLabel.setForeground(Color.GREEN);
                mossaClientLabel.setForeground(Color.RED);
                AnimazioneGoal(LabelTabellone);
            } else if (res == 2) {
                mossaServerLabel.setForeground(Color.RED);
                mossaClientLabel.setForeground(Color.GREEN);
                AnimazioneGoal(LabelTabellone);
            } else {
                mossaServerLabel.setForeground(Color.YELLOW);
                mossaClientLabel.setForeground(Color.YELLOW);
            }
        });
    }

    // TIMER TURNO SERVER E CLIENT
    private void InizioTimer(int secondi) {
        stopTimer();
        final int[] tempo = {secondi};

        timerLabel.setText(String.valueOf(tempo[0]));

        timer = new Timer(1000, e -> {
            tempo[0]--;
            timerLabel.setText(String.valueOf(tempo[0]));

            if (tempo[0] <= 0) {
                stopTimer();
                if (mossaServer == null) mossaServer = "timeout";
                SetBottoni(false, null); // disabilita bottoni fine turno
            }
        });

        timer.start();
    }

    private void stopTimer() {
        if (timer != null) timer.stop();
        timerLabel.setText("00");
    }

    // GESTIONE BOTTONI SERVER
    private void SetBottoni(boolean attivi, CountDownLatch latch) {
        SwingUtilities.invokeLater(() -> {
            for (JButton but : bottoni) {

                // Rimuove vecchi listener
                for (ActionListener listener : but.getActionListeners())
                	but.removeActionListener(listener);

                but.setEnabled(attivi);
                but.setBackground(attivi ? StiliPerGioco.ORO : Color.DARK_GRAY);

                // Collega listener per registrare mossa e sbloccare latch
                if (attivi && latch != null) {
                	but.addActionListener(e -> {
                        mossaServer = but.getText().toLowerCase();
                        mossaServerLabel.setText(mossaServer.toUpperCase());
                        SetBottoni(false, null); // disabilita bottoni dopo scelta
                        latch.countDown();       // segnala fine turno
                    });
                }
            }
        });
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(GiocoServer::new);
    }
}

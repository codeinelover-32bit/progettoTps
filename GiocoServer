import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.net.*;

public class GiocoServer extends JFrame {
    private PrintWriter out;
    private JLabel stato = new JLabel("IN ATTESA DEL CLIENT...");
    private JLabel timerLabel = new JLabel("Timer: --");
    private JLabel scoreLabel = new JLabel("0 - 0");
    private JLabel mossaServerLabel = new JLabel("-");
    private JLabel mossaClientLabel = new JLabel("-");
    private JButton[] bottoni = new JButton[3];
    private int puntiServer = 0, puntiClient = 0;
    private String mossaServer = null;
    private Timer timer;

    public GiocoServer() {
        super("Mortal Morra - SERVER");
        getContentPane().setBackground(UIStyle.BG);
        setLayout(new BorderLayout(20, 20));

        JPanel scoreboard = new JPanel(new GridBagLayout());
        scoreboard.setBackground(UIStyle.SCORE_BG);
        scoreboard.setBorder(BorderFactory.createLineBorder(Color.GRAY, 2));
        GridBagConstraints gbc = new GridBagConstraints(); gbc.insets = new Insets(10, 20, 10, 20);
        JLabel homeTag = new JLabel("SERVER"); homeTag.setForeground(UIStyle.HOME_COLOR); homeTag.setFont(UIStyle.NORMAL);
        JLabel awayTag = new JLabel("CLIENT"); awayTag.setForeground(UIStyle.AWAY_COLOR); awayTag.setFont(UIStyle.NORMAL);
        scoreLabel.setFont(UIStyle.SCORE_FONT); scoreLabel.setForeground(Color.YELLOW);
        gbc.gridx = 0; gbc.gridy = 0; scoreboard.add(homeTag, gbc);
        gbc.gridx = 1; gbc.gridy = 0; scoreboard.add(scoreLabel, gbc);
        gbc.gridx = 2; gbc.gridy = 0; scoreboard.add(awayTag, gbc);
        gbc.gridy = 1; gbc.gridx = 0; scoreboard.add(mossaServerLabel, gbc);
        gbc.gridx = 2; scoreboard.add(mossaClientLabel, gbc);

        JPanel mainPanel = new JPanel(new BorderLayout(10, 10));
        mainPanel.setOpaque(false);
        stato.setHorizontalAlignment(SwingConstants.CENTER); stato.setFont(UIStyle.TITLE); stato.setForeground(UIStyle.TEXT);

        JPanel card = UIStyle.createCardPanel();
        card.setLayout(new GridLayout(1, 3, 15, 0));
        String[] mosse = {"Sasso", "Carta", "Forbice"};
        for (int i = 0; i < 3; i++) {
            bottoni[i] = UIStyle.createButton(mosse[i]);
            bottoni[i].setEnabled(false);
            bottoni[i].addActionListener(e -> {
                mossaServer = e.getActionCommand().toLowerCase();
                mossaServerLabel.setText(mossaServer.toUpperCase());
                setButtonsEnabled(false);
                stato.setText("IN ATTESA DEL CLIENT...");
                stopTimer();
            });
            card.add(bottoni[i]);
        }

        mainPanel.add(stato, BorderLayout.NORTH); mainPanel.add(card, BorderLayout.CENTER);
        timerLabel.setHorizontalAlignment(SwingConstants.CENTER); timerLabel.setFont(new Font("Monospaced", Font.BOLD, 24));
        mainPanel.add(timerLabel, BorderLayout.SOUTH);
        add(scoreboard, BorderLayout.NORTH); add(mainPanel, BorderLayout.CENTER);
        setSize(800, 500); setLocationRelativeTo(null); setDefaultCloseOperation(EXIT_ON_CLOSE); setVisible(true);
        new Thread(this::startServer).start();
    }

    private void startServer() {
        try (ServerSocket serverSocket = new ServerSocket(5000)) {
            try (Socket socket = serverSocket.accept();
                 PrintWriter outS = new PrintWriter(socket.getOutputStream(), true);
                 BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()))) {
                out = outS;
                while (true) {
                    mossaServer = null;
                    SwingUtilities.invokeLater(() -> {
                        setButtonsEnabled(true);
                        stato.setText("TIRA IL RIGORE!");
                        mossaClientLabel.setText("...");
                        mossaServerLabel.setText("-");
                    });
                    out.println("INSERISCI_MOSSA");
                    startTimer();
                    String mossaClient = in.readLine();
                    if (mossaClient == null) break;
                    stopTimer();
                    if (mossaServer == null) mossaServer = "timeout";
                    int res = GameLogic.winner(mossaServer, mossaClient);
                    String msg;
                    if (res == 1) { puntiServer++; msg = "HAI VINTO!"; }
                    else if (res == 2) { puntiClient++; msg = "HAI PERSO..."; }
                    else { msg = "PAREGGIO!"; }
                    
                    SwingUtilities.invokeLater(() -> {
                        scoreLabel.setText(puntiServer + " - " + puntiClient);
                        mossaServerLabel.setText(mossaServer.toUpperCase());
                        mossaClientLabel.setText(mossaClient.toUpperCase());
                        stato.setText(msg);
                        setButtonsEnabled(false);
                    });
                    out.println("RISULTATO:" + mossaServer + ";" + mossaClient + ";" + res);
                    out.println("PUNTEGGIO:" + puntiServer + ";" + puntiClient);
                    Thread.sleep(2000);
                }
            }
        } catch (Exception e) { e.printStackTrace(); }
    }

    private void startTimer() {
        if (timer != null) timer.stop();
        timer = new Timer(1000, e -> {
            int t = Integer.parseInt(timerLabel.getText().replaceAll("\\D", "")) - 1;
            timerLabel.setText("Timer: " + t);
            if (t <= 0) { stopTimer(); mossaServer = "timeout"; setButtonsEnabled(false); stato.setText("IN ATTESA DEL CLIENT..."); }
        });
        timerLabel.setText("Timer: 10"); timer.start();
    }
    private void stopTimer() { if (timer != null) timer.stop(); timerLabel.setText("Timer: --"); }
    private void setButtonsEnabled(boolean en) { SwingUtilities.invokeLater(() -> { for (JButton b : bottoni) b.setEnabled(en); }); }
    public static void main(String[] args) { new GiocoServer(); }
}
